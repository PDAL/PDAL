version: 1.0.{build}

os:  Visual Studio 2015

platform: x64

configuration: Release

matrix:
  fast_finish: true

environment:
  OSGEO4W_ROOT: C:\OSGeo4W64

  matrix:
    - PDAL_OPTIONAL_COMPONENTS: OFF
    - PDAL_OPTIONAL_COMPONENTS: ON

init:
  - set PATH=C:\Program Files (x86)\MSBuild\14.0\Bin;%PATH%
  - set PATH=C:\Python27-x64\;%PATH%
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

install:
  # make a temp directory for downloading osgeo4w-setup.exe
  # this may not matter as much if part of the install step, as pdal has
  # already been cloned, otherwise git would complain about a non-empty
  # directory
  - ps: mkdir C:\temp | out-null

  # make the osgeo directory
  - ps: mkdir %OSGEO4W_ROOT% | out-null

  # make an install directory for packacing
  - ps: mkdir C:\pdalbin | out-null

  # get the OSGeo installer
  - ps: wget http://download.osgeo.org/osgeo4w/osgeo4w-setup-x86_64.exe -OutFile C:\temp\osgeo4w-setup.exe | out-null

  # and install our dependencies
  ## TODO: Clean up packages list once GDAL deps are fixed https://trac.osgeo.org/osgeo4w/ticket/485
  - C:\temp\osgeo4w-setup.exe -s http://download.osgeo.org/osgeo4w/ -a -q -r -P boost-devel,curl,eigen,expat,freexl,gdal,gdal110dll,gdal111dll,geos,hdf4,hdf5,hexer,iconv,laszip,libjpeg,libjpeg12,libgeotiff,libmysql,libpng,libpq,libtiff,libxml2,netcdf,nitro,ogdi,openjpeg,openssl,pcl,points2grid,proj,python-numpy,spatialite,sqlite3,zlib,xerces-c-vc10,xerces-c-vc9 -R %OSGEO4W_ROOT% > null
  ## TODO: remove this work-around once szip is fixed https://trac.osgeo.org/osgeo4w/ticket/486
  - ps: wget http://download.osgeo.org/osgeo4w/x86_64/release/szip/szip-2.1-1.tar.bz2 -OutFile C:\temp\szip-2.1-1.tar.bz2 | out-null
  - 7z x -so C:\temp\szip-2.1-1.tar.bz2 | 7z x -si -ttar -o%OSGEO4W_ROOT%
  # call our PDAL install script
  - call .\\scripts\\appveyor\\config.cmd

#cache:
#  # this should cache our OSGeo4W install between jobs in the build matrix
#  - C:\OSGeo4W64

build:
  parallel: true
  project: PDAL.sln
  verbosity: minimal

after_build:
  - 7z a pdal.zip %APPVEYOR_BUILD_FOLDER%\bin\*.*

test_script:
  # FIXME: Clear PATH to avoid OSGeo4W loading incompatible DLLs
  - set PATH=
  - set PATH=%OSGEO4W_ROOT%\bin;C:\Program Files (x86)\MSBuild\14.0\Bin;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Program Files\7-Zip;C:\Program Files\Microsoft Windows Performance Toolkit\;C:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\;C:\Python27;C:\Tools\GitVersion;C:\Program Files (x86)\CMake\bin;C:\Program Files\Git\cmd;C:\Program Files\Git\usr\bin;C:\Program Files\AppVeyor\BuildAgent\
  - echo %PATH%
  - set GDAL_DATA=%OSGEO4W_ROOT%\share\epsg_csv
  - set PROJ_LIB=%OSGEO4W_ROOT%\share\proj
  - ctest -V --output-on-failure -C Release

artifacts:
  - path: pdal.zip
    name: pdalmaster

deploy:
    # Amazon S3 deployment provider settings
  - provider: S3
    access_key_id:
      secure: 6DDLMtbxyT6amL3m5gmMObyL0ucWzIGxylinnYuMJPM=
    secret_access_key:
      secure: cSqZlsaCxFwXgxJw0BLd7npMFvQk3Vbr74ZPLaBQWLKnOz1cKss9qab1SzSygwkh
    bucket: "pdal"
    folder: "osgeo4w/"
    artifact: pdalmaster
    set_public: true

notifications:
  - provider: Email
    on_build_success: false
    on_build_failure: false
    on_build_status_changed: false

  - provider: Slack
    auth_token:
      secure: Ycvea4CbhP10k3tQwTr9vU2QMdYa4JusDfbCoOwkns2O87afn/G5eBsUakdM/eyW
    channel: '#pdal'
    on_build_failure: true
    on_build_success: false
    on_build_status_changed: true
